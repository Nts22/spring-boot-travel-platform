<!--
================================================================================
AGREGAR AL CARRITO - carrito/agregar.html
================================================================================
Formulario para agregar un paquete al carrito con servicios adicionales.

MODELO ESPERADO:
- paquete: PaqueteView
  - idPaquete, nombre, nombreDestino
  - precio: BigDecimal
  - fechaInicioFormateada, fechaFinFormateada
  - stockDisponible: Integer

- serviciosAdicionales: List<ServicioAdicionalView> (puede ser null/vacia)
  - idServicio: Integer
  - nombre: String
  - costoFormateado: String (ej: "S/ 50.00")

FLASH ATTRIBUTES:
- errorMessage: Mensaje de error de validacion

URL: /carrito/agregar/{idPaquete}
CONTROLADOR: CarritoWebController.mostrarFormularioAgregar()

ACCION DEL FORMULARIO:
- POST /carrito/agregar
- Campos: idPaquete, fechaViajeInicio, servicioIds[], servicioCantidades[]

JAVASCRIPT:
- Script inline para habilitar/deshabilitar campos de cantidad
  cuando se marca/desmarca un servicio adicional
================================================================================
-->

<section class="max-w-7xl mx-auto px-6 py-10">

    <!-- ═══════════════════════════════════════════════════════════════════════
         NAVEGACION - Breadcrumb
    ═══════════════════════════════════════════════════════════════════════ -->
    <nav class="mb-6 text-sm text-gray-500">
        <a th:href="@{/}" class="hover:text-red-600">Inicio</a>
        <span class="mx-2">/</span>
        <a th:href="@{/paquetes}" class="hover:text-red-600">Paquetes</a>
        <span class="mx-2">/</span>
        <a th:href="@{/paquetes/{id}(id=${paquete.idPaquete})}" class="hover:text-red-600" th:text="${paquete.nombre}">Paquete</a>
        <span class="mx-2">/</span>
        <span class="text-gray-700">Agregar al Carrito</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- ═══════════════════════════════════════════════════════════════════
             COLUMNA IZQUIERDA (2/3): Formulario
        ═══════════════════════════════════════════════════════════════════ -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-6 border">
                <h2 class="text-2xl font-bold mb-6">Agregar al Carrito</h2>

                <!-- Mensaje de error (flash message) -->
                <div th:if="${errorMessage}" class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    <span th:text="${errorMessage}"></span>
                </div>

                <form th:action="@{/carrito/agregar}" method="post" class="space-y-6">
                    <!-- Campo oculto: ID del paquete -->
                    <input type="hidden" name="idPaquete" th:value="${paquete.idPaquete}">

                    <!-- ═══════════════════════════════════════════════════════
                         CAMPO: Fecha de viaje
                         El usuario selecciona cuando quiere iniciar el viaje
                    ═══════════════════════════════════════════════════════ -->
                    <div>
                        <label for="fechaViajeInicio" class="block text-sm font-medium text-gray-700 mb-2">
                            Fecha de inicio del viaje *
                        </label>
                        <input type="date" id="fechaViajeInicio" name="fechaViajeInicio"
                               th:min="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                               required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <p class="mt-1 text-sm text-gray-500">Selecciona la fecha en que deseas iniciar tu viaje</p>
                    </div>

                    <!-- ═══════════════════════════════════════════════════════
                         SECCION: Servicios adicionales (opcional)
                         Solo se muestra si hay servicios disponibles
                    ═══════════════════════════════════════════════════════ -->
                    <div th:if="${serviciosAdicionales != null and !serviciosAdicionales.isEmpty()}">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Servicios adicionales (opcional)
                        </label>

                        <div class="space-y-3">
                            <!--
                            Iteracion sobre servicios adicionales
                            Cada servicio tiene:
                            - Checkbox para seleccionar
                            - Input oculto con el ID (deshabilitado hasta que se marque)
                            - Input de cantidad (deshabilitado hasta que se marque)
                            -->
                            <div th:each="servicio, stat : ${serviciosAdicionales}"
                                 class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">

                                <!-- Checkbox y nombre del servicio -->
                                <div class="flex items-center gap-3">
                                    <input type="checkbox"
                                           th:id="'servicio-' + ${servicio.idServicio}"
                                           class="servicio-checkbox w-5 h-5 text-red-600 border-gray-300 rounded focus:ring-red-500"
                                           th:data-index="${stat.index}">
                                    <div>
                                        <label th:for="'servicio-' + ${servicio.idServicio}"
                                               class="font-medium text-gray-800 cursor-pointer"
                                               th:text="${servicio.nombre}">Servicio</label>
                                        <p class="text-sm text-gray-500" th:text="${servicio.costoFormateado}">S/ 0.00</p>
                                    </div>
                                </div>

                                <!-- Input de ID (hidden) y cantidad -->
                                <div class="flex items-center gap-2">
                                    <!--
                                    IMPORTANTE: El input de servicioIds esta deshabilitado por defecto.
                                    Se habilita via JavaScript cuando el checkbox se marca.
                                    Esto evita enviar servicios no seleccionados.
                                    -->
                                    <input type="hidden" name="servicioIds" th:value="${servicio.idServicio}"
                                           th:id="'servicioId-' + ${stat.index}" disabled>
                                    <label th:for="'cantidad-' + ${servicio.idServicio}" class="text-sm text-gray-600">Cantidad:</label>
                                    <input type="number"
                                           th:id="'cantidad-' + ${servicio.idServicio}"
                                           name="servicioCantidades"
                                           min="1" max="10" value="1"
                                           disabled
                                           th:data-index="${stat.index}"
                                           class="cantidad-input w-20 px-3 py-1 border border-gray-300 rounded text-center disabled:bg-gray-200 disabled:cursor-not-allowed">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ═══════════════════════════════════════════════════════
                         BOTONES DE ACCION
                    ═══════════════════════════════════════════════════════ -->
                    <div class="flex gap-4 pt-4">
                        <button type="submit"
                                class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition font-medium flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Agregar al Carrito
                        </button>
                        <a th:href="@{/paquetes/{id}(id=${paquete.idPaquete})}"
                           class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════
             COLUMNA DERECHA (1/3): Resumen del paquete
             Card sticky que muestra info del paquete seleccionado
        ═══════════════════════════════════════════════════════════════════ -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6 border sticky top-6">
                <img th:src="@{/img/hero_3.jpg}" th:alt="${paquete.nombre}"
                     class="w-full h-40 object-cover rounded-lg mb-4">

                <h3 class="text-lg font-bold mb-2" th:text="${paquete.nombre}">Nombre del Paquete</h3>

                <p th:if="${paquete.nombreDestino}" class="text-sm text-gray-500 mb-3">
                    <span th:text="${paquete.nombreDestino}">Destino</span>
                </p>

                <div class="text-sm text-gray-600 space-y-2 mb-4">
                    <p>
                        <span class="font-medium">Duracion:</span>
                        <span th:text="${paquete.fechaInicioFormateada}">00/00</span> -
                        <span th:text="${paquete.fechaFinFormateada}">00/00</span>
                    </p>
                    <p>
                        <span class="font-medium">Disponibles:</span>
                        <span th:text="${paquete.stockDisponible}" class="text-green-600 font-medium">0</span> lugares
                    </p>
                </div>

                <div class="border-t pt-4">
                    <p class="text-sm text-gray-500">Precio por persona</p>
                    <p class="text-2xl font-bold text-red-600">
                        S/ <span th:text="${#numbers.formatDecimal(paquete.precio, 1, 2)}">0.00</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

</section>

<!-- ═══════════════════════════════════════════════════════════════════════════
     JAVASCRIPT: Control de servicios adicionales
     Habilita/deshabilita los campos de cantidad e ID cuando se marca un checkbox
═══════════════════════════════════════════════════════════════════════════ -->
<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Obtener todos los checkboxes de servicios
    const checkboxes = document.querySelectorAll('.servicio-checkbox');

    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            // Obtener el indice del servicio (data-index)
            const index = this.dataset.index;

            // Encontrar los inputs relacionados
            const cantidadInput = document.querySelector('.cantidad-input[data-index="' + index + '"]');
            const servicioIdInput = document.getElementById('servicioId-' + index);

            // Habilitar o deshabilitar segun el estado del checkbox
            if (this.checked) {
                cantidadInput.disabled = false;
                servicioIdInput.disabled = false;
            } else {
                cantidadInput.disabled = true;
                servicioIdInput.disabled = true;
            }
        });
    });
});
</script>
